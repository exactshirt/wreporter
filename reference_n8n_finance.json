{"nodes":[{"parameters":{"httpMethod":"POST","path":"wreporter-finance","options":{}},"name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-928,-976],"webhookId":"9520002c-e778-4908-a811-69dfc7fbbd3f","id":"139a3491-c463-4d03-afc1-70b6747654e0"},{"parameters":{"resource":"databasePage","operation":"get","pageId":{"__rl":true,"value":"={{ $json.body.data.id }}","mode":"id","__regex":"^([0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12})"},"simple":false},"name":"Get Deal Info","type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[-768,-976],"id":"2a58207e-22f3-4d12-ac70-06613ae24c96","credentials":{"notionApi":{"id":"BXwtVAYUnqn2vQIN","name":"wrtn-internal-agent"}}},{"parameters":{"jsCode":"const deal = items[0].json;\n\nconst companyRelation = deal.properties?.['COMPANY']?.relation || [];\nconst companyId = companyRelation[0]?.id || null;\nconst pageId = deal.id;\n\nif (!companyId) {\n  throw new Error('COMPANY ê´€ê³„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\n}\n\nreturn [{\n  json: {\n    company_id: companyId,\n    page_id: pageId\n  }\n}];"},"name":"Extract IDs","type":"n8n-nodes-base.code","typeVersion":2,"position":[-608,-976],"id":"6c9947df-29e4-45dc-bec7-34a712d34ede"},{"parameters":{"resource":"databasePage","operation":"get","pageId":{"__rl":true,"value":"={{ $json.company_id }}","mode":"id","__regex":"^([0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12})"},"simple":false},"name":"Get Company Name","type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[-448,-976],"id":"6b96b1ff-d40a-453a-a468-7fc548337ee1","credentials":{"notionApi":{"id":"BXwtVAYUnqn2vQIN","name":"wrtn-internal-agent"}}},{"parameters":{"jsCode":"const company = items[0].json;\nconst pageId = $('Get Deal Info').first().json.id;\n\nconst props = company.properties;\n\nconst corpName = props?.['COMPANY']?.title?.[0]?.plain_text || '';\nconst corpNameEng = props?.['ì˜ë¬¸ì´ë¦„']?.rich_text?.[0]?.plain_text || '';\nconst corpCode = props?.['ê³ ìœ ë²ˆí˜¸']?.rich_text?.[0]?.plain_text || '';\nconst ceoName = props?.['ëŒ€í‘œìëª…']?.rich_text?.[0]?.plain_text || '';\nconst address = props?.['ì£¼ì†Œ']?.rich_text?.[0]?.plain_text || '';\nconst empCount = props?.['ì§ì›ìˆ˜']?.number || null;\nconst estDate = props?.['ì„¤ë¦½ì¼']?.date?.start || '';\nconst homepage = props?.['í™ˆí˜ì´ì§€']?.url || '';\nconst indutyCode = props?.['induty_code']?.rich_text?.[0]?.plain_text || '';\nconst jurirNo = props?.['ë²•ì¸ë“±ë¡ë²ˆí˜¸']?.rich_text?.[0]?.plain_text || '';\nconst hasJurirNo = !!(jurirNo && jurirNo.trim().length > 0);\n\n// corp_code ìœ íš¨ì„± ì²´í¬ (8ìë¦¬ ìˆ«ì)\nconst hasCorpCode = !!(corpCode && corpCode.trim().length === 8);\n\nreturn [{\n  json: {\n    page_id: pageId,\n    corp_name: corpName,\n    corp_name_eng: corpNameEng,\n    corp_code: corpCode,\n    ceo_name: ceoName,\n    address: address,\n    emp_count: empCount,\n    est_date: estDate,\n    homepage: homepage,\n    induty_code: indutyCode,\n    has_corp_code: hasCorpCode,\n    jurir_no: jurirNo,\n    has_jurir_no: hasJurirNo\n  }\n}];"},"name":"Extract Company Info","type":"n8n-nodes-base.code","typeVersion":2,"position":[-288,-976],"id":"710efdcd-3a49-45d9-91dd-4d1615a0f9dc"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"corp-code-check","leftValue":"={{ $json.has_corp_code }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"name":"IF Has Corp Code","type":"n8n-nodes-base.if","typeVersion":2,"position":[-768,-736],"id":"aefea78a-2fbc-4577-b1dd-e47c3a9c1f61"},{"parameters":{"jsCode":"// =====================================================\n// Build No Data Context v0.3.0 â€” í™”ì´íŠ¸ë°•ìŠ¤\n// =====================================================\n// ëª¨ë“  ë°ì´í„° ì†ŒìŠ¤ íƒìƒ‰ í›„ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆì„ ë•Œ\n// Extract Company Infoì˜ has_corp_code/has_jurir_noë¡œ ê²½ë¡œ íŒë‹¨\n// =====================================================\n\nconst companyInfo = $('Extract Company Info').first().json;\nconst corpCode = companyInfo.corp_code || null;\nconst jurirNo = companyInfo.jurir_no || null;\nconst hasCorpCode = companyInfo.has_corp_code;\nconst hasJurirNo = companyInfo.has_jurir_no;\n\nconst searchPath = [];\nconst reasons = [];\n\n// DART ê²½ë¡œ íŒë‹¨\nif (hasCorpCode) {\n  reasons.push(`DART ì •ê¸°ë³´ê³ ì„œ ì¡°íšŒ: ì—†ìŒ (corp_code: ${corpCode})`);\n  searchPath.push({ step: 'DART Regular', key: 'corp_code', value: corpCode, result: 'no_report' });\n  reasons.push('DART ê°ì‚¬ë³´ê³ ì„œ ì¡°íšŒ: ì—†ìŒ');\n  searchPath.push({ step: 'DART Audit', key: 'corp_code', value: corpCode, result: 'no_report' });\n} else {\n  reasons.push('DART ì¡°íšŒ ë¶ˆê°€: ê³ ìœ ë²ˆí˜¸(corp_code) ì—†ìŒ');\n  searchPath.push({ step: 'DART', key: 'corp_code', value: null, result: 'skip' });\n}\n\n// FSC ê²½ë¡œ íŒë‹¨\nif (hasJurirNo) {\n  // hasJurirNo=trueì¸ë° ì´ ë…¸ë“œì— ë„ë‹¬ = FSC ì‹œë„í–ˆì§€ë§Œ ë°ì´í„° ì—†ìŒ\n  reasons.push(`FSC ì¬ë¬´ìƒíƒœí‘œ ì¡°íšŒ: ë°ì´í„° ì—†ìŒ (crno: ${jurirNo})`);\n  reasons.push(`FSC ì†ìµê³„ì‚°ì„œ ì¡°íšŒ: ë°ì´í„° ì—†ìŒ (crno: ${jurirNo})`);\n  searchPath.push({ step: 'FSC getBs', key: 'jurir_no', value: jurirNo, result: 'no_data' });\n  searchPath.push({ step: 'FSC getIncoStat', key: 'jurir_no', value: jurirNo, result: 'no_data' });\n} else {\n  reasons.push('FSC ì¡°íšŒ ë¶ˆê°€: ë²•ì¸ë“±ë¡ë²ˆí˜¸(jurir_no) ì—†ìŒ');\n  searchPath.push({ step: 'FSC', key: 'jurir_no', value: null, result: 'skip' });\n}\n\nreturn [{\n  json: {\n    page_id: companyInfo.page_id,\n    corp_name: companyInfo.corp_name,\n    corp_code: corpCode,\n    jurir_no: jurirNo,\n    finance_data: [],\n    yoy_change: {},\n    data_source: 'none',\n    no_data_reason: reasons.join('\\n'),\n    search_path: searchPath,\n    years_covered: '-',\n    report_type: null\n  }\n}];"},"name":"Build No Data Context","type":"n8n-nodes-base.code","typeVersion":2,"position":[288,656],"id":"cd0fc696-1f4d-4a74-9a2d-0d7ef4ba8c34"},{"parameters":{"url":"https://opendart.fss.or.kr/api/list.json","sendQuery":true,"queryParameters":{"parameters":[{"name":"crtfc_key","value":"091389ebb13e5db14eed5a4f0d2050f17e2c9264"},{"name":"corp_code","value":"={{ $('Extract Company Info').item.json.corp_code }}"},{"name":"pblntf_ty","value":"A"},{"name":"page_count","value":"100"},{"name":"bgn_de","value":"20230101"},{"name":"end_de","value":"={{ $now.format('yyyyMMdd') }}"}]},"options":{}},"name":"DART ê³µì‹œëª©ë¡","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-448,-752],"id":"186756bf-aada-4476-9184-9b66552ef7b5"},{"parameters":{"jsCode":"const response = items[0].json;\nconst list = response.list || [];\nconst companyInfo = $('Extract Company Info').first().json;\n\n// API ì—ëŸ¬ ì²´í¬\nif (response.status !== '000') {\n  return [{\n    json: {\n      page_id: companyInfo.page_id,\n      corp_name: companyInfo.corp_name,\n      corp_code: companyInfo.corp_code,\n      has_report: false,\n      report_status: 'api_error',\n      no_data_reason: `DART API ì˜¤ë¥˜: ${response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`\n    }\n  }];\n}\n\n// report_nmì—ì„œ ë³´ê³ ì„œ ì¢…ë¥˜ì™€ reprt_code ì¶”ì¶œ\nconst parseReportInfo = (reportNm) => {\n  if (reportNm.includes('ì‚¬ì—…ë³´ê³ ì„œ')) {\n    return { type: 'ì‚¬ì—…ë³´ê³ ì„œ', reprt_code: '11011', priority: 1, order: 4 };\n  }\n  if (reportNm.includes('ë°˜ê¸°ë³´ê³ ì„œ')) {\n    return { type: 'ë°˜ê¸°ë³´ê³ ì„œ', reprt_code: '11012', priority: 3, order: 2 };\n  }\n  if (reportNm.includes('ë¶„ê¸°ë³´ê³ ì„œ')) {\n    const monthMatch = reportNm.match(/\\(\\d{4}\\.(\\d{2})\\)/);\n    const month = monthMatch ? monthMatch[1] : '';\n    if (month === '03') {\n      return { type: '1ë¶„ê¸°ë³´ê³ ì„œ', reprt_code: '11013', priority: 4, order: 1 };\n    } else if (month === '09') {\n      return { type: '3ë¶„ê¸°ë³´ê³ ì„œ', reprt_code: '11014', priority: 2, order: 3 };\n    }\n    return { type: 'ë¶„ê¸°ë³´ê³ ì„œ', reprt_code: '11013', priority: 4, order: 1 };\n  }\n  return null;\n};\n\n// ì—°ë„ ì¶”ì¶œ ë° ë³´ê³ ì„œ ì •ë³´ íŒŒì‹±\nconst parsedReports = list\n  .map(item => {\n    const reportInfo = parseReportInfo(item.report_nm || '');\n    if (!reportInfo) return null;\n    \n    const yearMatch = item.report_nm.match(/\\((\\d{4})/);\n    const year = yearMatch ? parseInt(yearMatch[1]) : 0;\n    \n    return {\n      ...item,\n      year,\n      reprt_code: reportInfo.reprt_code,\n      report_type: reportInfo.type,\n      priority: reportInfo.priority,\n      order: reportInfo.order\n    };\n  })\n  .filter(item => item !== null);\n\n// ì—°ë„ë³„ ë³´ê³ ì„œ ëª©ë¡ ìƒì„±\nconst reportsByYear = {};\nparsedReports.forEach(r => {\n  if (!reportsByYear[r.year]) {\n    reportsByYear[r.year] = [];\n  }\n  // ì¤‘ë³µ ë°©ì§€\n  if (!reportsByYear[r.year].find(x => x.type === r.report_type)) {\n    reportsByYear[r.year].push({ type: r.report_type, order: r.order });\n  }\n});\n\n// ì—°ë„ë³„ ì •ë ¬ ë° í¬ë§·íŒ…\nconst sortedYears = Object.keys(reportsByYear).sort((a, b) => parseInt(a) - parseInt(b));\nconst reportsListText = sortedYears.map(year => {\n  const reports = reportsByYear[year]\n    .sort((a, b) => a.order - b.order)\n    .map(r => r.type)\n    .join(', ');\n  return ` - ${year}: ${reports}`;\n}).join('\\n');\n\n// ì •ë ¬ (ì—°ë„ ë‚´ë¦¼ì°¨ìˆœ â†’ ìš°ì„ ìˆœìœ„ ì˜¤ë¦„ì°¨ìˆœ)\nconst sortedReports = parsedReports.sort((a, b) => {\n  if (b.year !== a.year) return b.year - a.year;\n  return a.priority - b.priority;\n});\n\n// ê°€ì¥ ìµœê·¼ ì‚¬ì—…ë³´ê³ ì„œ ì°¾ê¸°\nconst latestAnnual = sortedReports.find(r => r.reprt_code === '11011');\n\nlet bestReport = null;\nlet reportStatus = '';\n\nif (latestAnnual) {\n  bestReport = latestAnnual;\n  reportStatus = `${bestReport.year}ë…„ ì‚¬ì—…ë³´ê³ ì„œ`;\n} else if (sortedReports.length > 0) {\n  bestReport = sortedReports[0];\n  reportStatus = `${bestReport.year}ë…„ ${bestReport.report_type}`;\n} else {\n  return [{\n    json: {\n      page_id: companyInfo.page_id,\n      corp_name: companyInfo.corp_name,\n      corp_code: companyInfo.corp_code,\n      has_report: false,\n      report_status: 'no_regular_report',\n      no_data_reason: 'ì •ê¸°ë³´ê³ ì„œ ì—†ìŒ (ìƒì¥íì§€/ë§¤ë§¤ê±°ë˜ì •ì§€ ë“±)'\n    }\n  }];\n}\n\nconst hasThreeYears = bestReport.reprt_code === '11011';\n\nreturn [{\n  json: {\n    page_id: companyInfo.page_id,\n    corp_name: companyInfo.corp_name,\n    corp_code: companyInfo.corp_code,\n    induty_code: companyInfo.induty_code,\n    has_report: true,\n    report_status: reportStatus,\n    rcept_no: bestReport.rcept_no,\n    reprt_code: bestReport.reprt_code,\n    bsns_year: String(bestReport.year),\n    report_nm: bestReport.report_nm,\n    has_three_years: hasThreeYears,\n    reports_list_text: reportsListText\n  }\n}];"},"name":"Find Best Report","type":"n8n-nodes-base.code","typeVersion":2,"position":[-288,-752],"id":"3267072b-bdcd-4887-a1dc-427b7c01ce97"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-report-check","leftValue":"={{ $json.has_report }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"name":"IF Has Report","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,-544],"id":"f6be3378-0991-4f3d-8106-f1097db28e29"},{"parameters":{"url":"https://opendart.fss.or.kr/api/fnlttSinglAcnt.json","sendQuery":true,"queryParameters":{"parameters":[{"name":"crtfc_key","value":"091389ebb13e5db14eed5a4f0d2050f17e2c9264"},{"name":"corp_code","value":"={{ $json.corp_code }}"},{"name":"bsns_year","value":"={{ $json.bsns_year }}"},{"name":"reprt_code","value":"={{ $json.reprt_code }}"},{"name":"fs_div","value":"CFS"}]},"options":{}},"name":"DART ì¬ë¬´ì œí‘œ","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-128,-560],"id":"eeacadea-be45-4857-b7e4-4f2a2a538041"},{"parameters":{"jsCode":"// =====================================================\n// Parse Finance Data v2 â€” 3ë…„ì¹˜ ì¶”ì¶œ + YoY ê³„ì‚°\n// =====================================================\n// DART fnlttSinglAcnt API ì‘ë‹µì—ì„œ ë‹¹ê¸°/ì „ê¸°/ì „ì „ê¸° ëª¨ë‘ ì¶”ì¶œ\n// =====================================================\n\nconst reportInfo = $('Find Best Report').first().json;\nconst dartResponse = items[0].json;\nconst list = dartResponse.list || [];\n\n// === í—¬í¼ í•¨ìˆ˜ ===\nconst parseNum = (str) => {\n  if (!str || str === '' || str === '-') return null;\n  const isNeg = str.includes('(') && str.includes(')');\n  const numStr = str.replace(/[^0-9]/g, '');\n  if (!numStr) return null;\n  const num = parseInt(numStr, 10);\n  return isNeg ? -num : num;\n};\n\n// ê³„ì •ê³¼ëª© ì°¾ê¸° â€” 3ë…„ì¹˜ ëª¨ë‘ ë°˜í™˜\nconst findAccount = (accountNm) => {\n  const item = list.find(row => {\n    const name = (row.account_nm || '').trim();\n    return name === accountNm;\n  });\n  // ì •í™• ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ í¬í•¨ ë§¤ì¹­\n  const fallbackItem = !item \n    ? list.find(row => (row.account_nm || '').includes(accountNm))\n    : null;\n  \n  const target = item || fallbackItem;\n  if (!target) return { current: null, previous: null, beforePrevious: null };\n  \n  return {\n    current: parseNum(target.thstrm_amount),\n    previous: parseNum(target.frmtrm_amount),\n    beforePrevious: parseNum(target.bfefrmtrm_amount),\n  };\n};\n\n// === ë§¤ì¶œì•¡ ëŒ€ì²´ ë¡œì§ (ì—…ì¢…ë³„ 7ë‹¨ê³„ fallback) ===\nconst findRevenue = () => {\n  const candidates = [\n    'ë§¤ì¶œì•¡',\n    'ì˜ì—…ìˆ˜ìµ',\n    'ì´ììˆ˜ìµ',\n    'ë³´í—˜ë£Œìˆ˜ìµ',\n    'ìš´ì†¡ìˆ˜ìµ',\n    'ì„œë¹„ìŠ¤ìˆ˜ìµ',\n    'ì„ëŒ€ìˆ˜ìµ',\n  ];\n  \n  for (const name of candidates) {\n    const result = findAccount(name);\n    if (result.current !== null && result.current !== 0) {\n      return { ...result, source: name };\n    }\n  }\n  \n  // ì´ììˆ˜ìµ + ìˆ˜ìˆ˜ë£Œìˆ˜ìµ í•©ì‚° (ì€í–‰ì—…)\n  const interest = findAccount('ì´ììˆ˜ìµ');\n  const fee = findAccount('ìˆ˜ìˆ˜ë£Œìˆ˜ìµ');\n  if (interest.current || fee.current) {\n    return {\n      current: (interest.current || 0) + (fee.current || 0),\n      previous: (interest.previous || 0) + (fee.previous || 0),\n      beforePrevious: (interest.beforePrevious || 0) + (fee.beforePrevious || 0),\n      source: 'ì´ììˆ˜ìµ+ìˆ˜ìˆ˜ë£Œìˆ˜ìµ',\n    };\n  }\n  \n  return { current: null, previous: null, beforePrevious: null, source: null };\n};\n\n// === ë°ì´í„° ì¶”ì¶œ ===\nconst revenue = findRevenue();\nconst currentAssets = findAccount('ìœ ë™ìì‚°');\nconst operatingProfit = findAccount('ì˜ì—…ì´ìµ');\nconst netIncome = (() => {\n  const ni = findAccount('ë‹¹ê¸°ìˆœì´ìµ');\n  if (ni.current !== null) return ni;\n  return findAccount('ë‹¹ê¸°ìˆœì†ìµ');\n})();\n\n// === ì—°ë„ ì •ë³´ ===\nconst year = parseInt(reportInfo.bsns_year);\nconst hasThreeYears = reportInfo.has_three_years || false;\n\n// === finance_data ë°°ì—´ êµ¬ì„± (ê³¼ê±° â†’ í˜„ì¬ ìˆœì„œ) ===\nconst financeData = [];\n\n// ì „ì „ê¸° (ì‚¬ì—…ë³´ê³ ì„œì¼ ë•Œë§Œ)\nif (hasThreeYears) {\n  const bfYear = {\n    year: String(year - 2),\n    current_assets: currentAssets.beforePrevious,\n    revenue: revenue.beforePrevious,\n    operating_profit: operatingProfit.beforePrevious,\n    net_income: netIncome.beforePrevious,\n  };\n  const hasBfData = Object.entries(bfYear)\n    .filter(([k]) => k !== 'year')\n    .some(([, v]) => v !== null);\n  if (hasBfData) financeData.push(bfYear);\n}\n\n// ì „ê¸°\nconst prevYear = {\n  year: String(year - 1),\n  current_assets: currentAssets.previous,\n  revenue: revenue.previous,\n  operating_profit: operatingProfit.previous,\n  net_income: netIncome.previous,\n};\nconst hasPrevData = Object.entries(prevYear)\n  .filter(([k]) => k !== 'year')\n  .some(([, v]) => v !== null);\nif (hasPrevData) financeData.push(prevYear);\n\n// ë‹¹ê¸°\nconst currYear = {\n  year: String(year),\n  current_assets: currentAssets.current,\n  revenue: revenue.current,\n  operating_profit: operatingProfit.current,\n  net_income: netIncome.current,\n};\nfinanceData.push(currYear);\n\n// === YoY ì¦ê°ë¥  ê³„ì‚° ===\nconst calcYoY = (curr, prev) => {\n  if (curr === null || prev === null || prev === 0) return null;\n  return (((curr - prev) / Math.abs(prev)) * 100).toFixed(1);\n};\n\nconst yoyChange = {};\nif (hasPrevData) {\n  yoyChange.current_assets = calcYoY(currYear.current_assets, prevYear.current_assets);\n  yoyChange.revenue = calcYoY(currYear.revenue, prevYear.revenue);\n  yoyChange.operating_profit = calcYoY(currYear.operating_profit, prevYear.operating_profit);\n  yoyChange.net_income = calcYoY(currYear.net_income, prevYear.net_income);\n}\n\n// === ì¶œë ¥ ===\nreturn [{\n  json: {\n    page_id: reportInfo.page_id,\n    corp_name: reportInfo.corp_name,\n    corp_code: reportInfo.corp_code,\n    finance_data: financeData,\n    yoy_change: yoyChange,\n    data_source: 'dart',\n    report_status: reportInfo.report_status,\n    report_nm: reportInfo.report_nm,\n    has_three_years: hasThreeYears,\n    reports_list_text: reportInfo.reports_list_text || '',\n    revenue_source: revenue.source || 'ë§¤ì¶œì•¡',\n    jurir_no: $('Extract Company Info').first().json.jurir_no || null,\n    upsert_data: {\n      jurir_no: $('Extract Company Info').first().json.jurir_no || null,\n      corp_code: reportInfo.corp_code,\n      bsns_year: reportInfo.bsns_year,\n      reprt_code: reportInfo.reprt_code,\n      revenue: currYear.revenue,\n      operating_profit: currYear.operating_profit,\n      net_income: currYear.net_income,\n      current_assets: currYear.current_assets,\n      frmtrm_revenue: hasPrevData ? prevYear.revenue : null,\n      frmtrm_operating_profit: hasPrevData ? prevYear.operating_profit : null,\n      frmtrm_net_income: hasPrevData ? prevYear.net_income : null,\n      frmtrm_current_assets: hasPrevData ? prevYear.current_assets : null,\n      bfefrmtrm_revenue: financeData.length >= 3 ? financeData[0].revenue : null,\n      bfefrmtrm_operating_profit: financeData.length >= 3 ? financeData[0].operating_profit : null,\n      bfefrmtrm_net_income: financeData.length >= 3 ? financeData[0].net_income : null,\n      bfefrmtrm_current_assets: financeData.length >= 3 ? financeData[0].current_assets : null,\n      report_type: reportInfo.report_status,\n      data_source: 'dart',\n      revenue_source: revenue.source || 'ë§¤ì¶œì•¡'\n    }\n  }\n}];"},"name":"Parse Finance Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-560],"id":"b6c8a93b-2af2-49db-8366-ef99c7cecae6"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO annual_reports (\n  jurir_no, corp_code, bsns_year, reprt_code,\n  revenue, operating_profit, net_income, current_assets,\n  frmtrm_revenue, frmtrm_operating_profit, frmtrm_net_income, frmtrm_current_assets,\n  bfefrmtrm_revenue, bfefrmtrm_operating_profit, bfefrmtrm_net_income, bfefrmtrm_current_assets,\n  report_type, data_source, revenue_source, updated_at\n) VALUES (\n  {{ $json.upsert_data.jurir_no ? \"'\" + $json.upsert_data.jurir_no + \"'\" : 'NULL' }},\n  '{{ $json.upsert_data.corp_code }}',\n  '{{ $json.upsert_data.bsns_year }}',\n  '{{ $json.upsert_data.reprt_code }}',\n  {{ $json.upsert_data.revenue || 'NULL' }},\n  {{ $json.upsert_data.operating_profit || 'NULL' }},\n  {{ $json.upsert_data.net_income || 'NULL' }},\n  {{ $json.upsert_data.current_assets || 'NULL' }},\n  {{ $json.upsert_data.frmtrm_revenue || 'NULL' }},\n  {{ $json.upsert_data.frmtrm_operating_profit || 'NULL' }},\n  {{ $json.upsert_data.frmtrm_net_income || 'NULL' }},\n  {{ $json.upsert_data.frmtrm_current_assets || 'NULL' }},\n  {{ $json.upsert_data.bfefrmtrm_revenue || 'NULL' }},\n  {{ $json.upsert_data.bfefrmtrm_operating_profit || 'NULL' }},\n  {{ $json.upsert_data.bfefrmtrm_net_income || 'NULL' }},\n  {{ $json.upsert_data.bfefrmtrm_current_assets || 'NULL' }},\n  '{{ $json.upsert_data.report_type }}',\n  '{{ $json.upsert_data.data_source }}',\n  '{{ $json.upsert_data.revenue_source }}',\n  NOW()\n)\nON CONFLICT (jurir_no, bsns_year) DO UPDATE SET\n  corp_code = EXCLUDED.corp_code,\n  reprt_code = EXCLUDED.reprt_code,\n  revenue = EXCLUDED.revenue,\n  operating_profit = EXCLUDED.operating_profit,\n  net_income = EXCLUDED.net_income,\n  current_assets = EXCLUDED.current_assets,\n  frmtrm_revenue = EXCLUDED.frmtrm_revenue,\n  frmtrm_operating_profit = EXCLUDED.frmtrm_operating_profit,\n  frmtrm_net_income = EXCLUDED.frmtrm_net_income,\n  frmtrm_current_assets = EXCLUDED.frmtrm_current_assets,\n  bfefrmtrm_revenue = EXCLUDED.bfefrmtrm_revenue,\n  bfefrmtrm_operating_profit = EXCLUDED.bfefrmtrm_operating_profit,\n  bfefrmtrm_net_income = EXCLUDED.bfefrmtrm_net_income,\n  bfefrmtrm_current_assets = EXCLUDED.bfefrmtrm_current_assets,\n  report_type = EXCLUDED.report_type,\n  data_source = EXCLUDED.data_source,\n  revenue_source = EXCLUDED.revenue_source,\n  updated_at = NOW()\nWHERE (\n  CASE annual_reports.data_source\n    WHEN 'dart' THEN 1 WHEN 'dart_api' THEN 1\n    WHEN 'dart_audit' THEN 2 WHEN 'audit_report' THEN 2\n    WHEN 'fsc' THEN 3\n    ELSE 999\n  END\n) >= (\n  CASE EXCLUDED.data_source\n    WHEN 'dart' THEN 1 WHEN 'dart_api' THEN 1\n    WHEN 'dart_audit' THEN 2 WHEN 'audit_report' THEN 2\n    WHEN 'fsc' THEN 3\n    ELSE 999\n  END\n);","options":{}},"name":"Supabase Upsert","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[592,-560],"id":"5ebb3ad8-c2b9-4fee-a310-605ae33f719c","credentials":{"postgres":{"id":"SeUIEEFN59o94egD","name":"Postgres account"}},"continueOnFail":true},{"parameters":{"modelId":{"__rl":true,"value":"claude-sonnet-4-5-20250929","mode":"list","cachedResultName":"claude-sonnet-4-5-20250929"},"messages":{"values":[{"content":"=## íƒ€ê²Ÿ ê¸°ì—…: {{ $json.corp_name }}\n\n## ë°ì´í„° ì¶œì²˜\n{{ $json.data_source === 'none' ? 'âŒ ' + $json.no_data_reason : 'âœ… ' + $json.report_status }}\n\n## ì¬ë¬´ ë°ì´í„°\n{{ $json.finance_data.length > 0 ? JSON.stringify($json.finance_data, null, 2) : 'ì¬ë¬´ ë°ì´í„° ì—†ìŒ' }}\n\n## ì „ë…„ ëŒ€ë¹„ ì¦ê°ë¥ \n{{ Object.keys($json.yoy_change).length > 0 ? JSON.stringify($json.yoy_change, null, 2) : 'ì¦ê°ë¥  ê³„ì‚° ë¶ˆê°€' }}\n\n---\n\n## ì‘ì„± ìš”ì²­\n\n{{ $json.data_source === 'none' ? 'ì´ ê¸°ì—…ì€ DARTì— ë“±ì¬ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì •ê¸°ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ì¬ë¬´ ë¶„ì„ì´ ë¶ˆê°€ëŠ¥í•¨ì„ ì•ˆë‚´í•˜ê³ , ëŒ€ì•ˆì ì¸ ì •ë³´ ìˆ˜ì§‘ ë°©ë²•(ë¹„ìƒì¥ ê¸°ì—… DB, ì§ì ‘ ë¬¸ì˜ ë“±)ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.' : 'ìœ„ ì¬ë¬´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.' }}\n\n## í•„ìˆ˜ í¬ë§· ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜)\n\n1. í—¤ë”©ì€ ### ë§Œ ì‚¬ìš© (## ë˜ëŠ” # ì‚¬ìš© ê¸ˆì§€)\n2. ëª¨ë“  ë‚´ìš©ì€ ë¶ˆë¦¿í¬ì¸íŠ¸(-)ë¡œ ì‘ì„±\n3. ë¶ˆë¦¿í¬ì¸íŠ¸ì˜ ë¬¸ì¥ì€ ëª…ì‚¬í˜•ìœ¼ë¡œ ì¢…ê²° (ì˜ˆ: \"~í•¨\", \"~ì„\", \"~ì¤‘\")\n4. ì„¸ë¶€ ì„¤ëª…ì€ ë“¤ì—¬ì“°ê¸° 4ì¹¸ + ë¶ˆë¦¿ìœ¼ë¡œ ì‘ì„± (nested bullet)\n5. ë³¼ë“œ(**) ì‚¬ìš© ê¸ˆì§€, ì´íƒ¤ë¦­(*í…ìŠ¤íŠ¸*)ì€ ê°•ì¡°ì—ë§Œ ì‚¬ìš©\n6. ë²ˆí˜¸ ëª©ë¡(1. 2. 3.) ì‚¬ìš© ê¸ˆì§€\n\n{{ $json.data_source !== 'none' ? '## í¬í•¨í•  ì„¹ì…˜\\n\\n### ì¬ë¬´ ê±´ì „ì„± í‰ê°€\\n- *ì¢‹ìŒ/ë³´í†µ/ì£¼ì˜* ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘\\n- íŒë‹¨ ê·¼ê±° 1~2ê°œ\\n\\n### í•µì‹¬ ë³€í™”\\n- ê°€ì¥ ì£¼ëª©í•  ìˆ˜ì¹˜ ë³€í™”\\n    - ì„¸ë¶€ ì„¤ëª… (nested bullet)\\n- í•´ì„ ë˜ëŠ” ì¶”ì • ì›ì¸\\n\\n### AI/DX íˆ¬ì ì—¬ë ¥\\n- íˆ¬ì ê°€ëŠ¥ì„± íŒë‹¨ (ê°€ëŠ¥/ì œí•œì /ì–´ë ¤ì›€)\\n- ê·¼ê±°\\n\\n### ì˜ì—… ì‹œ ê³ ë ¤ì‚¬í•­\\n- ì ‘ê·¼ ì „ëµ ì œì•ˆ\\n- ì£¼ì˜í•  ì ' : '' }}"}]},"options":{"system":"ë‹¹ì‹ ì€ B2B ì˜ì—…íŒ€ì„ ìœ„í•œ ì¬ë¬´ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\nê¸°ì—…ì˜ ì¬ë¬´ì œí‘œë¥¼ ë¶„ì„í•˜ì—¬ ì˜ì—…íŒ€ì´ ê³ ê°ì‚¬ì˜ ì¬ë¬´ ê±´ì „ì„±ê³¼ íˆ¬ì ì—¬ë ¥ì„ íŒŒì•…í•˜ëŠ” ê²ƒì„ ë•ìŠµë‹ˆë‹¤.\n\n## ë¶„ì„ ê´€ì \n1. ì„±ì¥ì„±: ë§¤ì¶œì•¡, ì˜ì—…ì´ìµ ì¦ê°€ ì¶”ì„¸\n2. ìˆ˜ìµì„±: ì˜ì—…ì´ìµë¥ , ìˆœì´ìµë¥ \n3. ì•ˆì •ì„±: ìœ ë™ìì‚° ê·œëª¨, ìë³¸ êµ¬ì¡°\n4. íˆ¬ì ì—¬ë ¥: AI/DX íˆ¬ì ê°€ëŠ¥ì„± íŒë‹¨\n\n## ì‘ì„± ì›ì¹™\n1. ìˆ«ìëŠ” 'ë°±ë§Œì›' ë˜ëŠ” 'ì–µì›' ë‹¨ìœ„ë¡œ ê°€ë…ì„± ìˆê²Œ í‘œê¸°\n2. ì „ë…„ ëŒ€ë¹„ ì¦ê°ë¥  ëª…ì‹œ\n3. ì—…ì¢… íŠ¹ì„± ê³ ë ¤í•œ í•´ì„\n4. ì˜ì—… ê´€ì ì˜ ì¸ì‚¬ì´íŠ¸ ì œê³µ\n5. ë¦¬ìŠ¤í¬ ìš”ì¸ ì†”ì§í•˜ê²Œ ì–¸ê¸‰\n6. ë§ºìŒë§/ì¶”ê°€ ë„ì›€ ì œì•ˆ ê¸ˆì§€ - ë¶„ì„ ë³¸ë¬¸ë§Œ ì¶œë ¥\n\n## ë°ì´í„° ì—†ëŠ” ê²½ìš°\n- ë¹„ìƒì¥/ì™¸ê°ì˜ë¬´ ì—†ëŠ” ê¸°ì—…ì€ ì¬ë¬´ ë¶„ì„ ë¶ˆê°€ ëª…ì‹œ\n- ëŒ€ì•ˆì  ì •ë³´ ìˆ˜ì§‘ ë°©ë²• ì œì•ˆ (í¬ë ˆë”§ì¡°íšŒ, ê¸°ì—…ì‹ ìš©í‰ê°€, ì§ì ‘ ë¬¸ì˜ ë“±)","maxTokens":4096}},"type":"@n8n/n8n-nodes-langchain.anthropic","typeVersion":1,"position":[592,656],"id":"b1c44619-8992-4b1a-be27-92fc45740c3d","name":"AI Writer Finance","credentials":{"anthropicApi":{"id":"fTy60tgbacg747sa","name":"Anthropic account"}}},{"parameters":{"url":"=https://api.notion.com/v1/blocks/{{ $('Get Deal Info').first().json.id }}/children","authentication":"predefinedCredentialType","nodeCredentialType":"notionApi","sendQuery":true,"queryParameters":{"parameters":[{"name":"page_size","value":"200"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Notion-Version","value":"2022-06-28"}]},"options":{}},"name":"Get Page Blocks","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[896,656],"id":"960c0086-b85e-4ed1-9f77-55b29a663fae","credentials":{"notionApi":{"id":"BXwtVAYUnqn2vQIN","name":"wrtn-internal-agent"}}},{"parameters":{"jsCode":"const blocks = items[0].json.results || [];\nconst pageId = $('Get Deal Info').first().json.id;\n\nconst aiOutput = $('AI Writer Finance').first().json;\nconst markdown = aiOutput.content?.[0]?.text || '';\n\n// ë°ì´í„° ì†ŒìŠ¤ ë…¸ë“œ íƒìƒ‰ (ì •ê¸°ë³´ê³ ì„œ â†’ ê°ì‚¬ë³´ê³ ì„œ â†’ No Data â†’ No Report ìˆœ)\nlet financeContext;\nconst sources = ['Parse Finance Data', 'Parse Audit XML', 'Parse FSC Finance Data', 'Parse FSC Summary Data', 'Build No Data Context'];\n\nfor (const src of sources) {\n  try {\n    financeContext = $(src).first().json;\n    if (financeContext && (financeContext.finance_data || financeContext.no_data_reason)) break;\n  } catch (e) {\n    continue;\n  }\n}\nfinanceContext = financeContext || {};\n\nconst marker = \"ğŸ“Š Finance Report\";\n\nlet anchorBlockId = null;\n\nfor (const block of blocks) {\n  const type = block.type;\n  if (['heading_2', 'heading_3', 'paragraph'].includes(type)) {\n    const richText = block[type]?.rich_text || [];\n    const text = richText.map(t => t.plain_text).join('');\n    if (text.includes(marker)) {\n      anchorBlockId = block.id;\n      break;\n    }\n  }\n}\n\nif (!anchorBlockId && blocks.length > 0) {\n  anchorBlockId = blocks[blocks.length - 1].id;\n}\n\nreturn [{\n  json: {\n    anchor_block_id: anchorBlockId,\n    page_id: pageId,\n    markdown: markdown,\n    finance_data: financeContext.finance_data || [],\n    yoy_change: financeContext.yoy_change || {},\n    corp_name: financeContext.corp_name || '',\n    data_source: financeContext.data_source || '',\n    report_status: financeContext.report_status || '',\n    report_nm: financeContext.report_nm || '',\n    has_three_years: financeContext.has_three_years || false,\n    reports_list_text: financeContext.reports_list_text || '',\n    revenue_source: financeContext.revenue_source || 'ë§¤ì¶œì•¡'\n  }\n}];"},"name":"Find Anchor Block","type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,656],"id":"380f1e9e-aba2-4547-a229-e75114a77d0f"},{"parameters":{"jsCode":"const data = items[0].json;\nconst financeData = data.finance_data || [];\nconst yoyChange = data.yoy_change || {};\nconst markdown = data.markdown || '';\nconst corpName = data.corp_name || '';\n\n// ë¦¬í¬íŠ¸ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°\nconst reportsListText = data.reports_list_text || '';\nconst reportNm = data.report_nm || '';\nconst hasThreeYears = data.has_three_years || false;\n\n// [ì¶”ê°€] Parse Finance Dataì—ì„œ revenue_source ê°€ì ¸ì˜¤ê¸°\nconst revenueSource = data.revenue_source || 'ë§¤ì¶œì•¡';\n\n// ìˆ«ì í¬ë§· í•¨ìˆ˜\nconst formatNumber = (num) => {\n  if (num === null || num === undefined || num === 'null') return '-';\n  const n = parseInt(num);\n  if (isNaN(n)) return '-';\n  const billions = n / 100000000;\n  if (Math.abs(billions) >= 1) {\n    return `${billions.toFixed(1)}ì–µì›`;\n  }\n  const millions = n / 1000000;\n  return `${millions.toFixed(0)}ë°±ë§Œì›`;\n};\n\n// ì¦ê°ë¥  í¬ë§·\nconst formatChange = (val) => {\n  if (!val || val === 'NaN') return '-';\n  const num = parseFloat(val);\n  if (isNaN(num)) return '-';\n  if (num > 0) return `â–²${num.toFixed(1)}%`;\n  if (num < 0) return `â–¼${Math.abs(num).toFixed(1)}%`;\n  return '0%';\n};\n\n// [ìˆ˜ì •] í‘œ í—¤ë”ì—ì„œ ë§¤ì¶œì•¡ ë¼ë²¨ ë™ì  ë³€ê²½\nconst revenueLabel = revenueSource !== 'ë§¤ì¶œì•¡' ? `ë§¤ì¶œì•¡(${revenueSource})` : 'ë§¤ì¶œì•¡';\n\n// í‘œ ë°ì´í„° êµ¬ì„±\nconst years = financeData.map(d => d.year);\nconst tableRows = [\n  ['êµ¬ë¶„', ...years.map(y => `${y}ë…„`), 'ì „ë…„ë¹„'],\n  ['ìœ ë™ìì‚°', ...financeData.map(d => formatNumber(d.current_assets)), formatChange(yoyChange.current_assets)],\n  [revenueLabel, ...financeData.map(d => formatNumber(d.revenue)), formatChange(yoyChange.revenue)],  // [ìˆ˜ì •] ë™ì  ë¼ë²¨ ì ìš©\n  ['ì˜ì—…ì´ìµ', ...financeData.map(d => formatNumber(d.operating_profit)), formatChange(yoyChange.operating_profit)],\n  ['ë‹¹ê¸°ìˆœì´ìµ', ...financeData.map(d => formatNumber(d.net_income)), formatChange(yoyChange.net_income)]\n];\n\n// Notion í‘œ ë¸”ë¡ ìƒì„±\nconst tableBlock = {\n  object: 'block',\n  type: 'table',\n  table: {\n    table_width: tableRows[0].length,\n    has_column_header: true,\n    has_row_header: true,\n    children: tableRows.map((row) => ({\n      object: 'block',\n      type: 'table_row',\n      table_row: {\n        cells: row.map(cell => [{\n          type: 'text',\n          text: { content: cell }\n        }])\n      }\n    }))\n  }\n};\n\n// ë§ˆí¬ë‹¤ìš´ íŒŒì‹± (nested bullet ì§€ì›)\nconst lines = markdown.split('\\n');\nconst analysisBlocks = [];\nlet i = 0;\n\nwhile (i < lines.length) {\n  const line = lines[i];\n  \n  if (!line.trim()) {\n    i++;\n    continue;\n  }\n  \n  if (line.startsWith('### ')) {\n    analysisBlocks.push({\n      object: 'block',\n      type: 'heading_3',\n      heading_3: {\n        rich_text: [{ type: 'text', text: { content: line.replace('### ', '') } }]\n      }\n    });\n    i++;\n    continue;\n  }\n  \n  if (line.match(/^- /)) {\n    const bulletText = line.replace(/^- /, '');\n    \n    // ì´íƒ¤ë¦­ íŒŒì‹± (*í…ìŠ¤íŠ¸*)\n    const richText = [];\n    const italicRegex = /\\*([^*]+)\\*/g;\n    let lastIndex = 0;\n    let match;\n    \n    while ((match = italicRegex.exec(bulletText)) !== null) {\n      if (match.index > lastIndex) {\n        richText.push({\n          type: 'text',\n          text: { content: bulletText.slice(lastIndex, match.index) }\n        });\n      }\n      richText.push({\n        type: 'text',\n        text: { content: match[1] },\n        annotations: { italic: true }\n      });\n      lastIndex = match.index + match[0].length;\n    }\n    if (lastIndex < bulletText.length) {\n      richText.push({\n        type: 'text',\n        text: { content: bulletText.slice(lastIndex) }\n      });\n    }\n    \n    // nested bullet ìˆ˜ì§‘\n    const children = [];\n    while (i + 1 < lines.length && lines[i + 1].match(/^    - /)) {\n      i++;\n      const nestedText = lines[i].replace(/^    - /, '');\n      children.push({\n        object: 'block',\n        type: 'bulleted_list_item',\n        bulleted_list_item: {\n          rich_text: [{ type: 'text', text: { content: nestedText } }]\n        }\n      });\n    }\n    \n    const bulletBlock = {\n      object: 'block',\n      type: 'bulleted_list_item',\n      bulleted_list_item: {\n        rich_text: richText.length > 0 ? richText : [{ type: 'text', text: { content: bulletText } }]\n      }\n    };\n    \n    if (children.length > 0) {\n      bulletBlock.bulleted_list_item.children = children;\n    }\n    \n    analysisBlocks.push(bulletBlock);\n    i++;\n    continue;\n  }\n  \n  analysisBlocks.push({\n    object: 'block',\n    type: 'paragraph',\n    paragraph: {\n      rich_text: [{ type: 'text', text: { content: line } }]\n    }\n  });\n  i++;\n}\n\n// === ë³´ê³ ì„œ ëª©ë¡ì„ ì—°ë„ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬ ===\nconst formatReportsList = (listText) => {\n  if (!listText) return 'ë³´ê³ ì„œ ëª©ë¡ ì—†ìŒ';\n  const items = listText.split(',').map(s => s.trim()).filter(Boolean);\n  const parsed = items.map(item => {\n    const yearMatch = item.match(/\\((\\d{4})/);\n    const year = yearMatch ? parseInt(yearMatch[1]) : 0;\n    return { year, name: item };\n  })\n  .sort((a, b) => a.year - b.year)\n  .filter(item => item.year > 0);\n  return parsed.map(p => ` - ${p.year}ë…„: ${p.name}`).join('\\n');\n};\n\n// ì˜¤ëŠ˜ ë‚ ì§œ í¬ë§·\nconst today = new Date();\nconst todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;\n\n// ë§¤ì¶œì•¡ ëŒ€ì²´ ì•ˆë‚´ ë¬¸êµ¬\nconst revenueNote = revenueSource !== 'ë§¤ì¶œì•¡' \n  ? `\\n - ë³¸ ë¦¬í¬íŠ¸ì˜ 'ë§¤ì¶œì•¡'ì€ ì—…ì¢… íŠ¹ì„±ì— ë”°ë¼ '${revenueSource}'ì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.`\n  : '';\n\n// ìœ ì˜ì‚¬í•­ ë¸”ë¡\nconst disclaimerBlocks = [\n  {\n    object: 'block',\n    type: 'divider',\n    divider: {}\n  },\n  {\n    object: 'block',\n    type: 'callout',\n    callout: {\n      rich_text: [\n        {\n          type: 'text',\n          text: { content: 'â€» ë°ì´í„° ì¶œì²˜ ì•ˆë‚´' },\n          annotations: { bold: true }\n        },\n        {\n          type: 'text',\n          text: { content: `\\n\\n${corpName}ì˜ 2023-01-01ë¶€í„° ${todayStr}ê¹Œì§€ ê²Œì‹œëœ ë³´ê³ ì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\\n${formatReportsList(reportsListText)}\\n\\nì´ ì¤‘ ${reportNm}ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\\n` }\n        },\n        {\n          type: 'text',\n          text: { content: 'â€» ì—…ì¢…ë³„ ì¬ë¬´ì§€í‘œ ì•ˆë‚´' },\n          annotations: { bold: true }\n        },\n        {\n          type: 'text',\n          text: { content: `\\n - ì¬ë¬´ì œí‘œëŠ” ì—°ê²°ì¬ë¬´ì œí‘œ(CFS) ê¸°ì¤€ì´ë©°, ë³„ë„ì¬ë¬´ì œí‘œì™€ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.${revenueNote}` }\n        }\n      ],\n      color: 'default'\n    }\n  }\n];\n\n// ì „ì²´ ë¸”ë¡ ì¡°í•©\nconst allBlocks = [\n  tableBlock,\n  ...analysisBlocks,\n  ...disclaimerBlocks\n];\n\nreturn [{\n  json: {\n    block_children: allBlocks,\n    page_id: data.page_id,\n    anchor_block_id: data.anchor_block_id\n  }\n}];"},"name":"Build Table Blocks","type":"n8n-nodes-base.code","typeVersion":2,"position":[1248,656],"id":"a2519263-0515-4dd6-92ef-3abc8280422f"},{"parameters":{"method":"PATCH","url":"=https://api.notion.com/v1/blocks/{{ $json.page_id }}/children","authentication":"predefinedCredentialType","nodeCredentialType":"notionApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Notion-Version","value":"2022-06-28"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"children\": {{ JSON.stringify($json.block_children) }},\n  \"after\": \"{{ $json.anchor_block_id }}\"\n}","options":{}},"name":"Append Report","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1424,656],"id":"8d9bb652-c6b8-424c-89b4-94f4da74251a","credentials":{"notionApi":{"id":"BXwtVAYUnqn2vQIN","name":"wrtn-internal-agent"}}},{"parameters":{"url":"https://opendart.fss.or.kr/api/list.json","sendQuery":true,"queryParameters":{"parameters":[{"name":"crtfc_key","value":"091389ebb13e5db14eed5a4f0d2050f17e2c9264"},{"name":"corp_code","value":"={{ $('Extract Company Info').item.json.corp_code }}"},{"name":"pblntf_ty","value":"F"},{"name":"page_count","value":"100"},{"name":"bgn_de","value":"20230101"},{"name":"end_de","value":"={{ $now.format('yyyyMMdd') }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-128,-368],"id":"6f0ab91c-c65f-4148-bd8f-74cc9262110e","name":"DART ê°ì‚¬ë³´ê³ ì„œ ëª©ë¡"},{"parameters":{"jsCode":"const response = items[0].json;\nconst companyInfo = $('Extract Company Info').first().json;\nconst reportInfo = $('Find Best Report').first().json;\n\n// API ì—ëŸ¬ ì²´í¬\nif (response.status !== '000' || !response.list) {\n  return [{\n    json: {\n      ...reportInfo,\n      has_audit: false,\n      no_data_reason: reportInfo.no_data_reason || 'ê°ì‚¬ë³´ê³ ì„œ ì—†ìŒ'\n    }\n  }];\n}\n\nconst list = response.list;\n\n// ê°ì‚¬ë³´ê³ ì„œ í•„í„° (F001: ê°ì‚¬ë³´ê³ ì„œ, F002: ì—°ê²°ê°ì‚¬ë³´ê³ ì„œ)\nconst auditReports = list\n  .filter(item => {\n    const nm = item.report_nm || '';\n    return nm.includes('ê°ì‚¬ë³´ê³ ì„œ') && !nm.includes('ë¯¸ì œì¶œ');\n  })\n  .map(item => {\n    const yearMatch = item.report_nm.match(/\\((\\d{4})/);\n    const year = yearMatch ? parseInt(yearMatch[1]) : 0;\n    const isLinked = item.report_nm.includes('ì—°ê²°');\n    return { ...item, year, isLinked };\n  })\n  // ìµœì‹  ì—°ë„ ìš°ì„ , ê°™ì€ ì—°ë„ë©´ ì—°ê²°ê°ì‚¬ë³´ê³ ì„œ ìš°ì„ \n  .sort((a, b) => {\n    if (b.year !== a.year) return b.year - a.year;\n    return (b.isLinked ? 1 : 0) - (a.isLinked ? 1 : 0);\n  });\n\nif (auditReports.length === 0) {\n  return [{\n    json: {\n      ...reportInfo,\n      has_audit: false,\n      no_data_reason: 'ê°ì‚¬ë³´ê³ ì„œ ì—†ìŒ'\n    }\n  }];\n}\n\nconst best = auditReports[0];\n\nreturn [{\n  json: {\n    page_id: reportInfo.page_id,\n    corp_name: reportInfo.corp_name,\n    corp_code: reportInfo.corp_code,\n    induty_code: companyInfo.induty_code || '',\n    has_audit: true,\n    report_status: `${best.year}ë…„ ${best.isLinked ? 'ì—°ê²°' : ''}ê°ì‚¬ë³´ê³ ì„œ`,\n    rcept_no: best.rcept_no,\n    bsns_year: String(best.year),\n    report_nm: best.report_nm,\n    is_linked: best.isLinked,\n    has_three_years: false,\n    reports_list_text: auditReports.slice(0, 5).map(r => r.report_nm).join(', ')\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-368],"id":"348d9919-2dda-447c-acef-bc5f1e7f8419","name":"Find Audit Report"},{"parameters":{"jsCode":"// =====================================================\n// Parse Audit XML v2 â€” 3ë‹¨ê³„ Fallback íŒŒì„œ\n// =====================================================\n// 1ë‹¨ê³„: TE/ACODE ë°”ì½”ë“œ ë°©ì‹ (XBRL íƒœê¹…ëœ XML)\n// 2ë‹¨ê³„: TD í…Œì´ë¸” ë°©ì‹ (HTML í‘œ í˜•íƒœ XML)\n// 3ë‹¨ê³„: SUMMARYë§Œ ì‚¬ìš© (ë§¤ì¶œì•¡ë§Œ ì¶”ì¶œ ê°€ëŠ¥)\n// =====================================================\n\n// === Binary â†’ XML ë¬¸ìì—´ ===\nconst binaryKeys = Object.keys(items[0].binary || {});\nif (binaryKeys.length === 0) {\n  return [{ json: { \n    page_id: $('Find Audit Report').first().json.page_id,\n    corp_name: $('Find Audit Report').first().json.corp_name,\n    corp_code: $('Find Audit Report').first().json.corp_code,\n    finance_data: [],\n    yoy_change: {},\n    data_source: 'none',\n    no_data_reason: 'ZIP í•´ì œ ì‹¤íŒ¨',\n    years_covered: '-',\n    report_type: null\n  }}];\n}\n\nconst binaryData = items[0].binary[binaryKeys[0]];\nlet xmlContent;\ntry {\n  // n8n Cloud: binaryê°€ ì™¸ë¶€ ì €ì¥ì†Œì— ìˆì„ ìˆ˜ ìˆìŒ\n  xmlContent = await this.helpers.getBinaryDataBuffer(0, binaryKeys[0]).then(buf => buf.toString('utf-8'));\n} catch (e) {\n  // Fallback: inline base64\n  xmlContent = Buffer.from(binaryData.data, 'base64').toString('utf-8');\n}\n\nconst auditInfo = $('Find Audit Report').first().json;\n\n// === SUMMARY ì¶”ì¶œ (ê³µí†µ) ===\nconst summary = {};\nconst sumRegex = /<EXTRACTION ACODE=\"(\\w+)\"[^>]*>([^<]*)<\\/EXTRACTION>/g;\nlet m;\nwhile ((m = sumRegex.exec(xmlContent)) !== null) {\n  summary[m[1]] = m[2];\n}\n\n// === ê³µí†µ í—¬í¼ í•¨ìˆ˜ ===\nconst parseNum = (str) => {\n  if (!str || str === '-' || str.trim() === '' || str === 'ã€€') return null;\n  const isNeg = str.includes('(') && str.includes(')');\n  const numStr = str.replace(/[^0-9]/g, '');\n  if (!numStr) return null;\n  const num = parseInt(numStr, 10);\n  return isNeg ? -num : num;\n};\n\nconst cleanText = (s) => {\n  return s.replace(/\\u3000/g, '').replace(/\\xa0/g, '').replace(/\\n/g, '').replace(/\\r/g, '').trim();\n};\n\n\n// ============================================================\n// 1ë‹¨ê³„: TE/ACODE ë°”ì½”ë“œ ë°©ì‹\n// ============================================================\nconst accounts = {};\nconst teRegex = /<TE[^>]*?ACODE=\"(\\d+)\"[^>]*?ADELIM=\"(\\d)\"[^>]*?>([^<]*)<\\/TE>/g;\nwhile ((m = teRegex.exec(xmlContent)) !== null) {\n  if (!accounts[m[1]]) accounts[m[1]] = {};\n  accounts[m[1]][m[2]] = m[3].trim();\n}\n\nconst teMatchCount = Object.keys(accounts).length;\n\nlet currentYear = null;\nlet prevYearData = null;\nlet revenueSource = null;\nlet parseMethod = 'none';  // ë””ë²„ê¹…ìš©: ì–´ë–¤ íŒŒì„œê°€ ì‚¬ìš©ë˜ì—ˆëŠ”ì§€\n\nif (teMatchCount > 0) {\n  // ----- 1ë‹¨ê³„: TE íŒŒì„œ -----\n  parseMethod = 'te_acode';\n  \n  const getValue = (acode) => {\n    const acc = accounts[acode];\n    if (!acc) return { current: null, previous: null };\n    return {\n      current: acc['2'] || acc['1'] || null,\n      previous: acc['4'] || acc['3'] || null\n    };\n  };\n  \n  // ë§¤ì¶œì•¡ fallback â€” IFRS + K-GAAP ACODE í†µí•©\n  const revenueCodes = [\n    { acode: '21000000010000', name: 'ë§¤ì¶œì•¡' },           // IFRS ë§¤ì¶œì•¡\n    { acode: '12100000010000', name: 'ë§¤ì¶œì•¡' },           // K-GAAP ë§¤ì¶œì•¡\n    { acode: '22000000010000', name: 'ì˜ì—…ìˆ˜ìµ' },         // IFRS ì˜ì—…ìˆ˜ìµ (ê¸ˆìœµì—…)\n  ];\n  let revenueData = { current: null, previous: null };\n  for (const rc of revenueCodes) {\n    const v = getValue(rc.acode);\n    if (v.current && parseNum(v.current)) {\n      revenueData = v;\n      revenueSource = rc.name;\n      break;\n    }\n  }\n  \n  // ìœ ë™ìì‚°\n  const currentAssets = getValue('11200000040000');\n  \n  // ì˜ì—…ì´ìµ â€” IFRS + K-GAAP\n  const opCodes = [\n    { acode: '21300000010000', name: 'ì˜ì—…ì´ìµ' },         // IFRS\n    { acode: '12500000010000', name: 'ì˜ì—…ì´ìµ' },         // K-GAAP\n  ];\n  let operatingProfit = { current: null, previous: null };\n  for (const oc of opCodes) {\n    const v = getValue(oc.acode);\n    if (v.current && parseNum(v.current) !== null) {\n      operatingProfit = v;\n      break;\n    }\n  }\n  \n  // ë‹¹ê¸°ìˆœì´ìµ â€” IFRS + K-GAAP\n  const niCodes = [\n    { acode: '21700000010000', name: 'ë‹¹ê¸°ìˆœì´ìµ' },       // IFRS\n    { acode: '12900000010000', name: 'ë‹¹ê¸°ìˆœì´ìµ' },       // K-GAAP\n    { acode: '22600000010000', name: 'ë‹¹ê¸°ìˆœì´ìµ' },       // IFRS ëŒ€ì²´\n  ];\n  let netIncome = { current: null, previous: null };\n  for (const nc of niCodes) {\n    const v = getValue(nc.acode);\n    if (v.current && parseNum(v.current) !== null) {\n      netIncome = v;\n      break;\n    }\n  }\n  \n  const year = parseInt(auditInfo.bsns_year);\n  currentYear = {\n    year: String(year),\n    current_assets: parseNum(currentAssets.current),\n    revenue: parseNum(revenueData.current),\n    operating_profit: parseNum(operatingProfit.current),\n    net_income: parseNum(netIncome.current)\n  };\n  prevYearData = {\n    year: String(year - 1),\n    current_assets: parseNum(currentAssets.previous),\n    revenue: parseNum(revenueData.previous),\n    operating_profit: parseNum(operatingProfit.previous),\n    net_income: parseNum(netIncome.previous)\n  };\n}\n\n\n// ============================================================\n// 2ë‹¨ê³„: TD í…Œì´ë¸” ë°©ì‹ (TE ë§¤ì¹˜ê°€ 0ì´ê±°ë‚˜ 1ë‹¨ê³„ ê²°ê³¼ê°€ ë¹ˆì•½í•  ë•Œ)\n// ============================================================\nconst teResultEmpty = !currentYear || \n  (currentYear.revenue === null && currentYear.operating_profit === null && currentYear.net_income === null);\n\nif (teResultEmpty) {\n  // TD íŒŒì„œ ì‹œë„\n  const trPattern = /<TR[^>]*>(.*?)<\\/TR>/gs;\n  const trs = [];\n  let trMatch;\n  while ((trMatch = trPattern.exec(xmlContent)) !== null) {\n    trs.push(trMatch[1]);\n  }\n  \n  if (trs.length > 0) {\n    parseMethod = 'td_table';\n    \n    // ê³„ì •ê³¼ëª© ë§¤ì¹­ ì‚¬ì „ (ìˆœì„œ = ìš°ì„ ìˆœìœ„)\n    const accountMap = {\n      current_assets: ['ìœ ë™ìì‚°'],\n      revenue: ['ë§¤ì¶œì•¡', 'ìˆ˜ìµ(ë§¤ì¶œì•¡)', 'ë§¤ì¶œ', 'ì˜ì—…ìˆ˜ìµ', 'ì´ììˆ˜ìµ', 'ë³´í—˜ë£Œìˆ˜ìµ', 'ìš´ì†¡ìˆ˜ìµ', 'ì„œë¹„ìŠ¤ìˆ˜ìµ'],\n      operating_profit: ['ì˜ì—…ì´ìµ', 'ì˜ì—…ì´ìµ(ì†ì‹¤)', 'ì˜ì—…ì†ì‹¤'],\n      net_income: ['ë‹¹ê¸°ìˆœì´ìµ(ì†ì‹¤)', 'ë‹¹ê¸°ìˆœì´ìµ', 'ë‹¹ê¸°ìˆœì†ìµ', 'ë‹¹ê¸°ìˆœì†ì‹¤', 'ë¶„ê¸°ìˆœì´ìµ(ì†ì‹¤)', 'ë°˜ê¸°ìˆœì´ìµ(ì†ì‹¤)'],\n    };\n    \n    const findAccount = (names) => {\n      for (const name of names) {\n        for (const tr of trs) {\n          // TDë¥¼ ì†ì„± í¬í•¨í•´ì„œ ì¶”ì¶œ\n          const tdPattern = /<TD([^>]*)>(.*?)<\\/TD>/gs;\n          const tdList = [];\n          let tdMatch;\n          while ((tdMatch = tdPattern.exec(tr)) !== null) {\n            tdList.push({ attrs: tdMatch[1], content: tdMatch[2] });\n          }\n          if (tdList.length === 0) continue;\n          \n          const firstText = cleanText(tdList[0].content);\n          // ì ‘ë‘ì‚¬ ì œê±° (ë¡œë§ˆìˆ«ì, ë²ˆí˜¸ ë“±)\n          const stripped = firstText.replace(/^[Iâ… â…¡â…¢â…£â…¤â…¥â…¦â…§â…¨â…©ivx0-9\\.\\(\\)\\s]+/, '');\n          \n          if (firstText === name || stripped === name) {\n            // RIGHT ì •ë ¬ëœ TDì—ì„œë§Œ ìˆ«ì ì¶”ì¶œ (ì£¼ì„ë²ˆí˜¸ CENTER ì œì™¸)\n            const numbers = [];\n            for (let i = 1; i < tdList.length; i++) {\n              if (tdList[i].attrs.toUpperCase().includes('RIGHT')) {\n                const val = parseNum(tdList[i].content);\n                if (val !== null) {\n                  numbers.push(val);\n                }\n              }\n            }\n            \n            if (numbers.length > 0) {\n              return {\n                matched: firstText,\n                current: numbers[0],\n                previous: numbers.length >= 2 ? numbers[1] : null,\n                beforePrevious: numbers.length >= 3 ? numbers[2] : null,\n              };\n            }\n          }\n        }\n      }\n      return null;\n    };\n    \n    const ca = findAccount(accountMap.current_assets);\n    const rev = findAccount(accountMap.revenue);\n    const op = findAccount(accountMap.operating_profit);\n    const ni = findAccount(accountMap.net_income);\n    \n    // ë§¤ì¶œ ì†ŒìŠ¤ ê¸°ë¡\n    if (rev) revenueSource = rev.matched;\n    \n    const year = parseInt(auditInfo.bsns_year);\n    currentYear = {\n      year: String(year),\n      current_assets: ca ? ca.current : null,\n      revenue: rev ? rev.current : null,\n      operating_profit: op ? op.current : null,\n      net_income: ni ? ni.current : null,\n    };\n    prevYearData = {\n      year: String(year - 1),\n      current_assets: ca ? ca.previous : null,\n      revenue: rev ? rev.previous : null,\n      operating_profit: op ? op.previous : null,\n      net_income: ni ? ni.previous : null,\n    };\n  }\n}\n\n\n// ============================================================\n// 3ë‹¨ê³„: SUMMARY Fallback (1,2ë‹¨ê³„ ëª¨ë‘ ì‹¤íŒ¨ ì‹œ)\n// ============================================================\nif (!currentYear || currentYear.revenue === null) {\n  if (!currentYear) {\n    const year = parseInt(auditInfo.bsns_year);\n    currentYear = {\n      year: String(year),\n      current_assets: null,\n      revenue: null,\n      operating_profit: null,\n      net_income: null,\n    };\n    prevYearData = {\n      year: String(year - 1),\n      current_assets: null,\n      revenue: null,\n      operating_profit: null,\n      net_income: null,\n    };\n  }\n  \n  // SUMMARYì—ì„œ ë§¤ì¶œì•¡ ë³´ì¶©\n  if (currentYear.revenue === null && summary.TOT_SALES) {\n    currentYear.revenue = parseInt(summary.TOT_SALES) * 1000000;\n    revenueSource = 'ë§¤ì¶œì•¡(ìš”ì•½)';\n    if (parseMethod === 'none') parseMethod = 'summary_only';\n  }\n}\n\n\n// ============================================================\n// ì¶œë ¥ êµ¬ì„± (Parse Finance Dataì™€ ë™ì¼í•œ êµ¬ì¡°)\n// ============================================================\nconst financeData = [];\nconst hasPrev = prevYearData && Object.entries(prevYearData)\n  .filter(([k, v]) => k !== 'year')\n  .some(v => v[1] !== null);\nif (hasPrev) financeData.push(prevYearData);\nfinanceData.push(currentYear);\n\n// YoY ì¦ê°ë¥ \nconst yoyChange = {};\nconst calcYoY = (curr, prev) => {\n  if (curr === null || prev === null || prev === 0) return null;\n  return (((curr - prev) / Math.abs(prev)) * 100).toFixed(1);\n};\nif (hasPrev) {\n  yoyChange.current_assets = calcYoY(currentYear.current_assets, prevYearData.current_assets);\n  yoyChange.revenue = calcYoY(currentYear.revenue, prevYearData.revenue);\n  yoyChange.operating_profit = calcYoY(currentYear.operating_profit, prevYearData.operating_profit);\n  yoyChange.net_income = calcYoY(currentYear.net_income, prevYearData.net_income);\n}\n\n// upsert_data (Supabase ì €ì¥ìš©)\nconst upsert_data = {\n  jurir_no: $('Extract Company Info').first().json.jurir_no || null,\n  corp_code: auditInfo.corp_code,\n  bsns_year: auditInfo.bsns_year,\n  reprt_code: 'audit',\n  revenue: currentYear.revenue,\n  operating_profit: currentYear.operating_profit,\n  net_income: currentYear.net_income,\n  current_assets: currentYear.current_assets,\n  frmtrm_revenue: prevYearData ? prevYearData.revenue : null,\n  frmtrm_operating_profit: prevYearData ? prevYearData.operating_profit : null,\n  frmtrm_net_income: prevYearData ? prevYearData.net_income : null,\n  frmtrm_current_assets: prevYearData ? prevYearData.current_assets : null,\n  bfefrmtrm_revenue: null,\n  bfefrmtrm_operating_profit: null,\n  bfefrmtrm_net_income: null,\n  bfefrmtrm_current_assets: null,\n  report_type: auditInfo.report_status,\n  data_source: 'dart_audit',\n  revenue_source: revenueSource || 'ë§¤ì¶œì•¡'\n};\n\nreturn [{\n  json: {\n    page_id: auditInfo.page_id,\n    corp_name: auditInfo.corp_name,\n    corp_code: auditInfo.corp_code,\n    finance_data: financeData,\n    yoy_change: yoyChange,\n    data_source: 'audit_report',\n    report_status: auditInfo.report_status,\n    report_nm: auditInfo.report_nm,\n    has_three_years: false,\n    reports_list_text: auditInfo.reports_list_text || '',\n    revenue_source: revenueSource || 'ë§¤ì¶œì•¡',\n    audit_opinion: summary.SUPV_OPIN || null,\n    ifrs_yn: summary.IFRS_YN || 'N',\n    total_employees: summary.TOT_EMPL ? parseInt(summary.TOT_EMPL) : null,\n    upsert_data: upsert_data,\n    _parse_method: parseMethod,\n    _te_match_count: teMatchCount,\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[192,-160],"id":"2aa0be92-8d83-4a5e-bbd1-000770197024","name":"Parse Audit XML"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"d35a00f8-b2e9-4f43-9fe1-4d1d955e8ddc","leftValue":"={{ $json.has_audit }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-448,-144],"id":"af69f816-71cf-4fe5-ab81-684e41f9113e","name":"IF Has Audit"},{"parameters":{"url":"https://opendart.fss.or.kr/api/document.xml","sendQuery":true,"queryParameters":{"parameters":[{"name":"crtfc_key","value":"091389ebb13e5db14eed5a4f0d2050f17e2c9264"},{"name":"rcept_no","value":"={{ $json.rcept_no }}"}]},"options":{"response":{"response":{"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-128,-160],"id":"c3b23be5-e774-42d7-b7f2-20dccd13661c","name":"Download Audit ZIP"},{"parameters":{},"type":"n8n-nodes-base.compression","typeVersion":1.1,"position":[32,-160],"id":"fab1da77-490c-408c-a651-77ab245b4ccd","name":"Decompress ZIP"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO annual_reports (\n  jurir_no, corp_code, bsns_year, reprt_code,\n  revenue, operating_profit, net_income, current_assets,\n  frmtrm_revenue, frmtrm_operating_profit, frmtrm_net_income, frmtrm_current_assets,\n  bfefrmtrm_revenue, bfefrmtrm_operating_profit, bfefrmtrm_net_income, bfefrmtrm_current_assets,\n  report_type, data_source, revenue_source, updated_at\n) VALUES (\n  {{ $json.upsert_data.jurir_no ? \"'\" + $json.upsert_data.jurir_no + \"'\" : 'NULL' }},\n  '{{ $json.upsert_data.corp_code }}',\n  '{{ $json.upsert_data.bsns_year }}',\n  '{{ $json.upsert_data.reprt_code }}',\n  {{ $json.upsert_data.revenue || 'NULL' }},\n  {{ $json.upsert_data.operating_profit || 'NULL' }},\n  {{ $json.upsert_data.net_income || 'NULL' }},\n  {{ $json.upsert_data.current_assets || 'NULL' }},\n  {{ $json.upsert_data.frmtrm_revenue || 'NULL' }},\n  {{ $json.upsert_data.frmtrm_operating_profit || 'NULL' }},\n  {{ $json.upsert_data.frmtrm_net_income || 'NULL' }},\n  {{ $json.upsert_data.frmtrm_current_assets || 'NULL' }},\n  {{ $json.upsert_data.bfefrmtrm_revenue || 'NULL' }},\n  {{ $json.upsert_data.bfefrmtrm_operating_profit || 'NULL' }},\n  {{ $json.upsert_data.bfefrmtrm_net_income || 'NULL' }},\n  {{ $json.upsert_data.bfefrmtrm_current_assets || 'NULL' }},\n  '{{ $json.upsert_data.report_type }}',\n  '{{ $json.upsert_data.data_source }}',\n  '{{ $json.upsert_data.revenue_source }}',\n  NOW()\n)\nON CONFLICT (jurir_no, bsns_year) DO UPDATE SET\n  corp_code = EXCLUDED.corp_code,\n  reprt_code = EXCLUDED.reprt_code,\n  revenue = EXCLUDED.revenue,\n  operating_profit = EXCLUDED.operating_profit,\n  net_income = EXCLUDED.net_income,\n  current_assets = EXCLUDED.current_assets,\n  frmtrm_revenue = EXCLUDED.frmtrm_revenue,\n  frmtrm_operating_profit = EXCLUDED.frmtrm_operating_profit,\n  frmtrm_net_income = EXCLUDED.frmtrm_net_income,\n  frmtrm_current_assets = EXCLUDED.frmtrm_current_assets,\n  report_type = EXCLUDED.report_type,\n  data_source = EXCLUDED.data_source,\n  revenue_source = EXCLUDED.revenue_source,\n  updated_at = NOW()\nWHERE (\n  CASE annual_reports.data_source\n    WHEN 'dart' THEN 1 WHEN 'dart_api' THEN 1\n    WHEN 'dart_audit' THEN 2 WHEN 'audit_report' THEN 2\n    WHEN 'fsc' THEN 3\n    ELSE 999\n  END\n) >= (\n  CASE EXCLUDED.data_source\n    WHEN 'dart' THEN 1 WHEN 'dart_api' THEN 1\n    WHEN 'dart_audit' THEN 2 WHEN 'audit_report' THEN 2\n    WHEN 'fsc' THEN 3\n    ELSE 999\n  END\n);","options":{}},"name":"Supabase Upsert1","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[592,-160],"id":"29a9c074-8d6a-47de-946a-3b24f6507bdb","credentials":{"postgres":{"id":"SeUIEEFN59o94egD","name":"Postgres account"}},"continueOnFail":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"jurir-no-check-1","leftValue":"={{ $json.has_jurir_no }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"name":"IF Has Jurir No","type":"n8n-nodes-base.if","typeVersion":2,"position":[-464,640],"id":"44e4a41a-6a2e-42c6-b6e9-9af7f30c5cb5"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"jurir-no-check-2","leftValue":"={{ $('Extract Company Info').first().json.has_jurir_no }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"name":"IF Has Jurir No 2","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,96],"id":"606d6e63-f852-45ab-932e-62289a6544cd"},{"parameters":{"url":"https://apis.data.go.kr/1160100/service/GetFinaStatInfoService_V2/getBs_V2","sendQuery":true,"queryParameters":{"parameters":[{"name":"serviceKey","value":"P5kkCZbaulysGj6Lh6ANNIHoi5VS2PQ/6Hkk4MldF+9HDb+Ihv7jmPjpm2Ie7SnbIi0FXydv1FtffF+4a1jeQg=="},{"name":"resultType","value":"json"},{"name":"numOfRows","value":"100"},{"name":"crno","value":"={{ $('Extract Company Info').first().json.jurir_no }}"}]},"options":{}},"name":"FSC getBs_V2","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-128,80],"id":"ccc6de7c-432e-446f-ac12-ea131c752681"},{"parameters":{"url":"https://apis.data.go.kr/1160100/service/GetFinaStatInfoService_V2/getIncoStat_V2","sendQuery":true,"queryParameters":{"parameters":[{"name":"serviceKey","value":"P5kkCZbaulysGj6Lh6ANNIHoi5VS2PQ/6Hkk4MldF+9HDb+Ihv7jmPjpm2Ie7SnbIi0FXydv1FtffF+4a1jeQg=="},{"name":"resultType","value":"json"},{"name":"numOfRows","value":"100"},{"name":"crno","value":"={{ $('Extract Company Info').first().json.jurir_no }}"}]},"options":{}},"name":"FSC getIncoStat_V2","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[32,80],"id":"23a88e34-98e9-4fae-99a1-6c6fc5c9ce4a"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fsc-data-check","leftValue":"={{ ($('FSC getBs_V2').first().json.response?.body?.totalCount || 0) > 0 || ($('FSC getIncoStat_V2').first().json.response?.body?.totalCount || 0) > 0 }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"name":"IF Has FSC Data","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,336],"id":"f6d41ac3-35f6-4d91-a32c-4dc587494e54"},{"parameters":{"jsCode":"// =====================================================\n// Parse FSC Finance Data v0.3.0\n// =====================================================\n// FSC getBs_V2 + getIncoStat_V2 â†’ v0.2.2 í˜¸í™˜ ì¶œë ¥\n// =====================================================\n\nconst companyInfo = $('Extract Company Info').first().json;\nconst bsResponse = $('FSC getBs_V2').first().json;\nconst isResponse = $('FSC getIncoStat_V2').first().json;\n\n// === API ì‘ë‹µì—ì„œ item ë°°ì—´ ì¶”ì¶œ ===\nconst extractItems = (resp) => {\n  const items = resp?.response?.body?.items?.item;\n  if (!items) return [];\n  return Array.isArray(items) ? items : [items];\n};\n\nconst bsItems = extractItems(bsResponse);\nconst isItems = extractItems(isResponse);\nconst allItems = [...bsItems, ...isItems];\n\n// === ìµœì‹  bizYear ì„ íƒ ===\nconst years = [...new Set(allItems.map(i => i.bizYear).filter(Boolean))].sort().reverse();\nconst latestYear = years[0];\n\nif (!latestYear) {\n  return [{\n    json: {\n      page_id: companyInfo.page_id,\n      corp_name: companyInfo.corp_name,\n      finance_data: [],\n      yoy_change: {},\n      data_source: 'none',\n      no_data_reason: 'FSC API ì‘ë‹µì— ìœ íš¨í•œ ì—°ë„ ì—†ìŒ'\n    }\n  }];\n}\n\n// === fnclDcd ìš°ì„ ìˆœìœ„ (ì—°ê²° IFRS > ë³„ë„ IFRS > ì—°ê²° K-GAAP > ë³„ë„ K-GAAP) ===\nconst fnclDcdPriority = (dcd) => {\n  if (!dcd) return 999;\n  if (dcd.includes('ifrs_ConsolidatedMember')) return 1;\n  if (dcd.includes('ifrs_SeparateMember')) return 2;\n  if (dcd.includes('gaap_ConsolidatedMember')) return 3;\n  if (dcd.includes('gaap_SeparateMember')) return 4;\n  return 999;\n};\n\n// BS/IS ê°ê° ìµœì  fnclDcd ì„ íƒ\nconst pickBest = (items) => {\n  const latest = items.filter(i => i.bizYear === latestYear);\n  const dcds = [...new Set(latest.map(i => i.fnclDcd).filter(Boolean))];\n  dcds.sort((a, b) => fnclDcdPriority(a) - fnclDcdPriority(b));\n  return latest.filter(i => i.fnclDcd === dcds[0]);\n};\n\nconst bsFiltered = pickBest(bsItems);\nconst isFiltered = pickBest(isItems);\n\n// === í—¬í¼ í•¨ìˆ˜ ===\nconst parseAmt = (str) => {\n  if (!str || str === '' || str === '0') return null;\n  const cleaned = String(str).replace(/[^0-9\\-]/g, '');\n  if (!cleaned || cleaned === '0') return null;\n  const num = parseInt(cleaned, 10);\n  return isNaN(num) ? null : num;\n};\n\nconst findAccount = (items, names) => {\n  for (const name of names) {\n    const item = items.find(i => {\n      const acitNm = (i.acitNm || '').trim();\n      return acitNm === name || acitNm.includes(name);\n    });\n    if (item && (parseAmt(item.crtmAcitAmt) !== null)) {\n      return {\n        current: parseAmt(item.crtmAcitAmt),\n        previous: parseAmt(item.pvtrAcitAmt),\n        beforePrevious: parseAmt(item.bpvtrAcitAmt),\n        source: (item.acitNm || '').trim()\n      };\n    }\n  }\n  return { current: null, previous: null, beforePrevious: null, source: null };\n};\n\n// === ê³„ì •ê³¼ëª© ì¶”ì¶œ ===\nconst currentAssets = findAccount(bsFiltered, ['ìœ ë™ìì‚°']);\n\n// ë§¤ì¶œì•¡ 7ë‹¨ê³„ fallback (DARTì™€ ë™ì¼)\nconst revenue = findAccount(isFiltered, [\n  'ë§¤ì¶œì•¡', 'ìˆ˜ìµ(ë§¤ì¶œì•¡)', 'ì˜ì—…ìˆ˜ìµ', 'ì´ììˆ˜ìµ',\n  'ë³´í—˜ë£Œìˆ˜ìµ', 'ìš´ì†¡ìˆ˜ìµ', 'ì„œë¹„ìŠ¤ìˆ˜ìµ', 'ì„ëŒ€ìˆ˜ìµ'\n]);\n\nconst operatingProfit = findAccount(isFiltered, ['ì˜ì—…ì´ìµ', 'ì˜ì—…ì´ìµ(ì†ì‹¤)']);\n\nconst netIncome = (() => {\n  const ni = findAccount(isFiltered, ['ë‹¹ê¸°ìˆœì´ìµ', 'ë‹¹ê¸°ìˆœì´ìµ(ì†ì‹¤)']);\n  if (ni.current !== null) return ni;\n  return findAccount(isFiltered, ['ë‹¹ê¸°ìˆœì†ìµ']);\n})();\n\n// === finance_data ë°°ì—´ êµ¬ì„± (ê³¼ê±°â†’í˜„ì¬ ìˆœì„œ) ===\nconst year = parseInt(latestYear);\nconst financeData = [];\n\n// ì „ì „ê¸°\nconst bfYear = {\n  year: String(year - 2),\n  current_assets: currentAssets.beforePrevious,\n  revenue: revenue.beforePrevious,\n  operating_profit: operatingProfit.beforePrevious,\n  net_income: netIncome.beforePrevious\n};\nconst hasBfData = Object.entries(bfYear)\n  .filter(([k]) => k !== 'year')\n  .some(([, v]) => v !== null);\nif (hasBfData) financeData.push(bfYear);\n\n// ì „ê¸°\nconst prevYear = {\n  year: String(year - 1),\n  current_assets: currentAssets.previous,\n  revenue: revenue.previous,\n  operating_profit: operatingProfit.previous,\n  net_income: netIncome.previous\n};\nconst hasPrevData = Object.entries(prevYear)\n  .filter(([k]) => k !== 'year')\n  .some(([, v]) => v !== null);\nif (hasPrevData) financeData.push(prevYear);\n\n// ë‹¹ê¸°\nconst currYear = {\n  year: String(year),\n  current_assets: currentAssets.current,\n  revenue: revenue.current,\n  operating_profit: operatingProfit.current,\n  net_income: netIncome.current\n};\nfinanceData.push(currYear);\n\n// === YoY ì¦ê°ë¥  ===\nconst calcYoY = (curr, prev) => {\n  if (curr === null || prev === null || prev === 0) return null;\n  return (((curr - prev) / Math.abs(prev)) * 100).toFixed(1);\n};\n\nconst yoyChange = {};\nif (hasPrevData) {\n  yoyChange.current_assets = calcYoY(currYear.current_assets, prevYear.current_assets);\n  yoyChange.revenue = calcYoY(currYear.revenue, prevYear.revenue);\n  yoyChange.operating_profit = calcYoY(currYear.operating_profit, prevYear.operating_profit);\n  yoyChange.net_income = calcYoY(currYear.net_income, prevYear.net_income);\n}\n\n// === ì¶œë ¥ (v0.2.2 í˜¸í™˜) ===\nreturn [{\n  json: {\n    page_id: companyInfo.page_id,\n    corp_name: companyInfo.corp_name,\n    corp_code: companyInfo.corp_code || null,\n    jurir_no: companyInfo.jurir_no,\n    finance_data: financeData,\n    yoy_change: yoyChange,\n    data_source: 'fsc',\n    report_status: `FSC ê¸°ì—…ì¬ë¬´ì •ë³´ (${latestYear}ë…„ ê¸°ì¤€)`,\n    report_nm: `FSC ê¸°ì—…ì¬ë¬´ì •ë³´ (${latestYear}ë…„ ê¸°ì¤€)`,\n    revenue_source: revenue.source || 'ë§¤ì¶œì•¡',\n    has_three_years: hasBfData && hasPrevData,\n    reports_list_text: '',\n    search_path: [\n      { step: 'DART', result: companyInfo.has_corp_code ? 'no_report' : 'skip' },\n      { step: 'FSC', key: 'jurir_no', value: companyInfo.jurir_no, result: 'success' }\n    ],\n    upsert_data: {\n      jurir_no: companyInfo.jurir_no,\n      corp_code: companyInfo.corp_code || null,\n      bsns_year: latestYear,\n      revenue: currYear.revenue,\n      operating_profit: currYear.operating_profit,\n      net_income: currYear.net_income,\n      current_assets: currYear.current_assets,\n      data_source: 'fsc'\n    }\n  }\n}];"},"name":"Parse FSC Finance Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-128,320],"id":"ad64de41-b690-4e3f-9ed0-bf4f077b483a"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO annual_reports (\n  id, jurir_no, corp_code, bsns_year,\n  revenue, operating_profit, net_income, current_assets,\n  data_source, created_at\n) VALUES (\n  gen_random_uuid(),\n  '{{ $json.upsert_data.jurir_no }}',\n  {{ $json.upsert_data.corp_code ? \"'\" + $json.upsert_data.corp_code + \"'\" : 'NULL' }},\n  '{{ $json.upsert_data.bsns_year }}',\n  {{ $json.upsert_data.revenue || 'NULL' }},\n  {{ $json.upsert_data.operating_profit || 'NULL' }},\n  {{ $json.upsert_data.net_income || 'NULL' }},\n  {{ $json.upsert_data.current_assets || 'NULL' }},\n  'fsc',\n  NOW()\n)\nON CONFLICT (jurir_no, bsns_year) DO UPDATE SET\n  revenue = EXCLUDED.revenue,\n  operating_profit = EXCLUDED.operating_profit,\n  net_income = EXCLUDED.net_income,\n  current_assets = EXCLUDED.current_assets,\n  data_source = EXCLUDED.data_source\nWHERE (\n  CASE annual_reports.data_source\n    WHEN 'dart' THEN 1 WHEN 'dart_api' THEN 1\n    WHEN 'dart_audit' THEN 2 WHEN 'audit_report' THEN 2\n    WHEN 'fsc' THEN 3\n    ELSE 999\n  END\n) >= (\n  CASE EXCLUDED.data_source\n    WHEN 'dart' THEN 1 WHEN 'dart_api' THEN 1\n    WHEN 'dart_audit' THEN 2 WHEN 'audit_report' THEN 2\n    WHEN 'fsc' THEN 3\n    ELSE 999\n  END\n);","options":{}},"name":"Supabase Upsert FSC","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[592,304],"id":"606630c7-13be-4a5e-9267-8b5ad99c1548","credentials":{"postgres":{"id":"SeUIEEFN59o94egD","name":"Postgres account"}},"continueOnFail":true},{"parameters":{"url":"https://apis.data.go.kr/1160100/service/GetFinaStatInfoService_V2/getSummFinaStat_V2","sendQuery":true,"queryParameters":{"parameters":[{"name":"serviceKey","value":"P5kkCZbaulysGj6Lh6ANNIHoi5VS2PQ/6Hkk4MldF+9HDb+Ihv7jmPjpm2Ie7SnbIi0FXydv1FtffF+4a1jeQg=="},{"name":"resultType","value":"json"},{"name":"numOfRows","value":"100"},{"name":"crno","value":"={{ $('Extract Company Info').first().json.jurir_no }}"}]},"options":{}},"name":"FSC getSummFinaStat_V2","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-128,480],"id":"cc377e83-f02e-47d1-b679-a7b16db6632f"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fsc-summary-check","leftValue":"={{ ($json.response?.body?.totalCount || 0) > 0 }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"name":"IF Has FSC Summary","type":"n8n-nodes-base.if","typeVersion":2,"position":[80,480],"id":"f84b42f2-d80b-4174-a466-dcf3fd2f8503"},{"parameters":{"jsCode":"// =====================================================\n// Parse FSC Summary Data v0.3.0\n// =====================================================\n// getSummFinaStat_V2 â†’ v0.2.2 í˜¸í™˜ ì¶œë ¥\n// ìš”ì•½ì¬ë¬´ì œí‘œëŠ” ì—°ë„ë³„ 1row, ìœ ë™ìì‚° ì—†ìŒ (ì´ìì‚°ë§Œ ìˆìŒ)\n// =====================================================\n\nconst companyInfo = $('Extract Company Info').first().json;\nconst summResponse = $('FSC getSummFinaStat_V2').first().json;\n\n// === API ì‘ë‹µì—ì„œ item ë°°ì—´ ì¶”ì¶œ ===\nlet items = summResponse?.response?.body?.items?.item || [];\nif (!Array.isArray(items)) items = items ? [items] : [];\n\nif (items.length === 0) {\n  return [{\n    json: {\n      page_id: companyInfo.page_id,\n      corp_name: companyInfo.corp_name,\n      finance_data: [],\n      yoy_change: {},\n      data_source: 'none',\n      no_data_reason: 'FSC ìš”ì•½ì¬ë¬´ì œí‘œì—ë„ ë°ì´í„° ì—†ìŒ'\n    }\n  }];\n}\n\n// === fnclDcd ìš°ì„ ìˆœìœ„ ===\n// getSummFinaStat_V2ì˜ fnclDcd ì½”ë“œ: 110=ì—°ê²°, 120=ë³„ë„ ë“±\nconst fnclPriority = (dcd) => {\n  const d = String(dcd || '');\n  if (d.includes('ifrs_Consolidated') || d === '110') return 1;\n  if (d.includes('ifrs_Separate') || d === '120') return 2;\n  if (d.includes('gaap_Consolidated') || d === '310') return 3;\n  if (d.includes('gaap_Separate') || d === '320') return 4;\n  return 999;\n};\n\n// === ì—°ë„ë³„ ê·¸ë£¹í•‘ í›„ ìµœì  fnclDcd ì„ íƒ ===\nconst byYear = {};\nfor (const it of items) {\n  const yr = it.bizYear;\n  if (!yr) continue;\n  if (!byYear[yr]) byYear[yr] = [];\n  byYear[yr].push(it);\n}\n\n// ê° ì—°ë„ë³„ë¡œ ìš°ì„ ìˆœìœ„ ë†’ì€ í•­ëª© ì„ íƒ\nconst bestByYear = {};\nfor (const [yr, rows] of Object.entries(byYear)) {\n  rows.sort((a, b) => fnclPriority(a.fnclDcd) - fnclPriority(b.fnclDcd));\n  bestByYear[yr] = rows[0];\n}\n\n// ìµœì‹  3ê°œ ì—°ë„ ì„ íƒ\nconst sortedYears = Object.keys(bestByYear).sort().reverse().slice(0, 3).reverse();\n\n// === í—¬í¼ ===\nconst parseAmt = (val) => {\n  if (!val || val === '0' || val === '') return null;\n  const n = parseInt(String(val).replace(/[^0-9\\-]/g, ''), 10);\n  return isNaN(n) ? null : n;\n};\n\n// === finance_data êµ¬ì„± (ê³¼ê±°â†’í˜„ì¬) ===\nconst financeData = sortedYears.map(yr => {\n  const it = bestByYear[yr];\n  return {\n    year: yr,\n    current_assets: null,  // ìš”ì•½ì¬ë¬´ì œí‘œì—ëŠ” ìœ ë™ìì‚° ì—†ìŒ\n    revenue: parseAmt(it.enpSaleAmt),\n    operating_profit: parseAmt(it.enpBzopPft),\n    net_income: parseAmt(it.enpCrtmNpf),\n    // ì¶”ê°€ ì •ë³´ (AI Writer ì°¸ê³ ìš©)\n    total_assets: parseAmt(it.enpTastAmt),\n    total_debt: parseAmt(it.enpTdbtAmt),\n    total_equity: parseAmt(it.enpTcptAmt),\n  };\n});\n\nconst latestYear = sortedYears[sortedYears.length - 1];\n\n// === YoY (ìµœì‹  2ê°œ ì—°ë„ ë¹„êµ) ===\nconst calcYoY = (curr, prev) => {\n  if (curr === null || prev === null || prev === 0) return null;\n  return (((curr - prev) / Math.abs(prev)) * 100).toFixed(1);\n};\n\nconst yoyChange = {};\nif (financeData.length >= 2) {\n  const curr = financeData[financeData.length - 1];\n  const prev = financeData[financeData.length - 2];\n  yoyChange.revenue = calcYoY(curr.revenue, prev.revenue);\n  yoyChange.operating_profit = calcYoY(curr.operating_profit, prev.operating_profit);\n  yoyChange.net_income = calcYoY(curr.net_income, prev.net_income);\n  yoyChange.total_assets = calcYoY(curr.total_assets, prev.total_assets);\n}\n\n// === ì¶œë ¥ ===\nreturn [{\n  json: {\n    page_id: companyInfo.page_id,\n    corp_name: companyInfo.corp_name,\n    corp_code: companyInfo.corp_code || null,\n    jurir_no: companyInfo.jurir_no,\n    finance_data: financeData,\n    yoy_change: yoyChange,\n    data_source: 'fsc_summary',\n    report_status: `FSC ìš”ì•½ì¬ë¬´ì œí‘œ (${latestYear}ë…„ ê¸°ì¤€)`,\n    report_nm: `FSC ìš”ì•½ì¬ë¬´ì œí‘œ (${latestYear}ë…„ ê¸°ì¤€)`,\n    revenue_source: 'ë§¤ì¶œì•¡',\n    has_three_years: financeData.length >= 3,\n    reports_list_text: '',\n    search_path: [\n      { step: 'DART', result: companyInfo.has_corp_code ? 'no_report' : 'skip' },\n      { step: 'FSC getBs/getIncoStat', result: 'no_data' },\n      { step: 'FSC getSummFinaStat', key: 'jurir_no', value: companyInfo.jurir_no, result: 'success' }\n    ],\n    upsert_data: {\n      jurir_no: companyInfo.jurir_no,\n      corp_code: companyInfo.corp_code || null,\n      bsns_year: latestYear,\n      revenue: financeData[financeData.length - 1].revenue,\n      operating_profit: financeData[financeData.length - 1].operating_profit,\n      net_income: financeData[financeData.length - 1].net_income,\n      current_assets: null,\n      data_source: 'fsc'\n    }\n  }\n}];"},"name":"Parse FSC Summary Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[288,464],"id":"f6f2fe2e-c49a-4ebb-b4b6-51246fed5366"}],"connections":{"Webhook":{"main":[[{"node":"Get Deal Info","type":"main","index":0}]]},"Get Deal Info":{"main":[[{"node":"Extract IDs","type":"main","index":0}]]},"Extract IDs":{"main":[[{"node":"Get Company Name","type":"main","index":0}]]},"Get Company Name":{"main":[[{"node":"Extract Company Info","type":"main","index":0}]]},"Extract Company Info":{"main":[[{"node":"IF Has Corp Code","type":"main","index":0}]]},"IF Has Corp Code":{"main":[[{"node":"DART ê³µì‹œëª©ë¡","type":"main","index":0}],[{"node":"IF Has Jurir No","type":"main","index":0}]]},"Build No Data Context":{"main":[[{"node":"AI Writer Finance","type":"main","index":0}]]},"DART ê³µì‹œëª©ë¡":{"main":[[{"node":"Find Best Report","type":"main","index":0}]]},"Find Best Report":{"main":[[{"node":"IF Has Report","type":"main","index":0}]]},"IF Has Report":{"main":[[{"node":"DART ì¬ë¬´ì œí‘œ","type":"main","index":0}],[{"node":"DART ê°ì‚¬ë³´ê³ ì„œ ëª©ë¡","type":"main","index":0}]]},"DART ì¬ë¬´ì œí‘œ":{"main":[[{"node":"Parse Finance Data","type":"main","index":0}]]},"Parse Finance Data":{"main":[[{"node":"Supabase Upsert","type":"main","index":0},{"node":"AI Writer Finance","type":"main","index":0}]]},"AI Writer Finance":{"main":[[{"node":"Get Page Blocks","type":"main","index":0}]]},"Get Page Blocks":{"main":[[{"node":"Find Anchor Block","type":"main","index":0}]]},"Find Anchor Block":{"main":[[{"node":"Build Table Blocks","type":"main","index":0}]]},"Build Table Blocks":{"main":[[{"node":"Append Report","type":"main","index":0}]]},"DART ê°ì‚¬ë³´ê³ ì„œ ëª©ë¡":{"main":[[{"node":"Find Audit Report","type":"main","index":0}]]},"Find Audit Report":{"main":[[{"node":"IF Has Audit","type":"main","index":0}]]},"Parse Audit XML":{"main":[[{"node":"AI Writer Finance","type":"main","index":0},{"node":"Supabase Upsert1","type":"main","index":0}]]},"IF Has Audit":{"main":[[{"node":"Download Audit ZIP","type":"main","index":0}],[{"node":"IF Has Jurir No 2","type":"main","index":0}]]},"Download Audit ZIP":{"main":[[{"node":"Decompress ZIP","type":"main","index":0}]]},"Decompress ZIP":{"main":[[{"node":"Parse Audit XML","type":"main","index":0}]]},"IF Has Jurir No":{"main":[[{"node":"FSC getBs_V2","type":"main","index":0}],[{"node":"Build No Data Context","type":"main","index":0}]]},"IF Has Jurir No 2":{"main":[[{"node":"FSC getBs_V2","type":"main","index":0}],[{"node":"Build No Data Context","type":"main","index":0}]]},"FSC getBs_V2":{"main":[[{"node":"FSC getIncoStat_V2","type":"main","index":0}]]},"FSC getIncoStat_V2":{"main":[[{"node":"IF Has FSC Data","type":"main","index":0}]]},"IF Has FSC Data":{"main":[[{"node":"Parse FSC Finance Data","type":"main","index":0}],[{"node":"FSC getSummFinaStat_V2","type":"main","index":0}]]},"Parse FSC Finance Data":{"main":[[{"node":"Supabase Upsert FSC","type":"main","index":0},{"node":"AI Writer Finance","type":"main","index":0}]]},"FSC getSummFinaStat_V2":{"main":[[{"node":"IF Has FSC Summary","type":"main","index":0}]]},"IF Has FSC Summary":{"main":[[{"node":"Parse FSC Summary Data","type":"main","index":0}],[{"node":"Build No Data Context","type":"main","index":0}]]},"Parse FSC Summary Data":{"main":[[{"node":"Supabase Upsert FSC","type":"main","index":0},{"node":"AI Writer Finance","type":"main","index":0}]]}},"pinData":{},"meta":{"templateCredsSetupCompleted":true,"instanceId":"1678b82955be672e9ebce40b9ebdd4155d78be2335d2de2b28dbeaa98007a0af"}}